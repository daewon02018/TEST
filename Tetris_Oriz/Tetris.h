#include <windows.h>
#include <stdlib.h>
#include "resource.h"
#include <time.h>
#include <winuser.h>

#define random(n) (rand()%n)
#define randomize() srand((unsigned)time(NULL))

LRESULT CALLBACK WndProc(HWND,UINT,WPARAM,LPARAM);
BOOL CALLBACK AboutDlgProc(HWND hDlg,UINT iMessage,WPARAM wParam,LPARAM lParam);
void InitStage();
void DrawBlock();
void DrawScreen();
void NewBlock();
void DrawBack();
void DrawPiece(int, int);
void DrawNextBlock();
void DrawNextPiece(int, int, int, int);
void DrawAllBlock();
void RotateBlock();
int CheckBlock(int, int);
int CheckRotate(int);
void FullCheck();
void SaveBlock();
void DeleteBlock();
void MoveDown();
void MoveLeft();
void MoveRight();
void MoveBottom();
void DrawScore();
void StageCheck(int);
void StageClear();
void CenterWindow(HWND hWnd);

HINSTANCE g_hInst;
HDC hDC, MainMemDC, BackMemDC, NextBackMemDC, BMemDC[6];
HBITMAP MainImg, BackImg, NextBackImg, BlockImg[7];
HWND hWnd;
HDC MemDC;
HBITMAP Bitmap, OldBitmap;

const int Piece[19][8] = {{0,0,1,0,2,0,3,0}, {1,0,0,1,1,1,2,1}, {1,0,2,0,0,1,1,1}, {0,0,1,0,1,1,2,1},
						 {0,0,1,0,2,0,0,1}, {0,0,1,0,2,0,2,1}, {0,0,1,0,0,1,1,1}, {0,0,0,1,0,2,0,3},
						 {1,0,0,1,1,1,1,2}, {0,0,1,0,2,0,1,1}, {1,0,1,1,2,1,1,2}, {0,0,0,1,1,1,1,2},
						 {1,0,0,1,1,1,0,2}, {0,0,0,1,0,2,1,2}, {2,0,0,1,1,1,2,1}, {0,0,1,0,1,1,1,2},
						 {0,0,1,0,0,1,0,2}, {0,0,0,1,1,1,2,1}, {1,0,1,1,0,2,1,2}};

const int TBack[12][20][12] =  {{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage1
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage2
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{0,8,0,8,0,8,0,8,0,8,0,8}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage3
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,1,1,8,8,8,8,8},
								{8,8,8,8,1,2,2,1,8,8,8,8},
								{8,8,8,1,2,3,3,2,1,8,8,8},
								{8,8,1,2,3,4,4,3,2,1,8,8},
								{8,1,2,3,4,5,5,4,3,2,1,8}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage4
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,0},
								{8,8,8,8,8,8,8,8,8,8,0,1},
								{8,8,8,8,8,8,8,8,8,0,1,2},
								{8,8,8,8,8,8,8,8,0,1,2,3},
								{8,8,8,8,8,8,8,0,1,2,3,4},
								{8,8,8,8,8,8,0,1,2,3,4,5},
								{8,8,8,8,8,0,1,2,3,4,5,6},
								{8,8,8,8,0,1,2,3,4,5,6,0},
								{8,8,8,0,1,2,3,4,5,6,0,1},
								{8,8,0,1,2,3,4,5,6,0,1,2},
								{8,0,1,2,3,4,5,6,0,1,2,3}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage5
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{2,2,1,1,0,0,6,6,5,5,8,4},
								{3,3,2,2,1,8,0,0,6,6,5,5},
								{4,4,3,3,2,2,1,1,0,0,6,8},
								{5,5,4,4,3,3,8,2,1,1,0,0},
								{6,8,5,5,4,4,3,3,2,2,1,1}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage6
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{4,8,4,8,4,8,4,8,4,8,4,8},
								{4,8,4,8,4,8,4,8,4,8,4,8},
								{8,5,8,5,8,5,8,5,8,5,8,5},
								{8,5,8,5,8,5,8,5,8,5,8,5}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage7
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{5,8,5,8,5,8,5,8,5,8,5,8},
								{8,5,8,5,8,5,8,5,8,5,8,5},
								{5,8,5,8,5,8,5,8,5,8,5,8},
								{8,5,8,5,8,5,8,5,8,5,8,5},
								{5,8,5,8,5,8,5,8,5,8,5,8}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage8
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{0,8,8,0,2,2,2,2,5,8,8,5},
								{0,8,0,8,8,8,2,8,5,8,5,8},
								{0,0,8,8,8,8,2,8,5,5,8,8},
								{0,0,8,8,8,8,2,8,5,5,8,8},
								{0,8,0,8,2,8,2,8,5,8,5,8},
								{0,8,8,0,8,2,2,8,5,8,8,5},
								{8,8,8,8,8,8,8,8,8,8,8,8}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage9
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{6,6,6,6,6,6,8,6,6,6,6,6},
								{6,6,6,6,6,8,6,8,6,6,6,6},
								{6,6,6,6,8,6,8,6,8,6,6,6},
								{6,6,6,8,6,8,6,8,6,8,6,6},
								{6,6,8,6,8,6,8,6,8,6,8,6},
								{6,6,6,8,6,8,6,8,6,8,6,6},
								{6,6,6,6,8,6,8,6,8,6,6,6},
								{6,6,6,6,6,8,6,8,6,6,6,6},
								{6,6,6,6,6,6,8,6,6,6,6,6}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage10
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,2,2,2,2,2,2,2,2,8,8},
								{8,2,8,8,8,8,8,8,8,8,2,8},
								{2,8,8,2,8,8,8,8,2,8,8,2},
								{2,8,2,8,2,8,8,2,8,2,8,2},
								{2,8,8,8,8,8,8,8,8,8,8,2},
								{2,8,8,8,8,8,8,8,8,8,8,2},
								{2,8,8,2,8,8,8,8,2,8,8,2},
								{2,8,8,8,2,2,2,2,8,8,8,2},
								{8,2,8,8,8,8,8,8,8,8,2,8},
								{8,8,2,2,2,2,2,2,2,2,8,8}},

								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage11
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,3,3,3,3,3,3,3,3,8,8},
								{8,3,8,8,8,8,8,8,8,8,3,8},
								{3,8,8,8,8,8,8,8,8,8,8,3},
								{3,8,3,3,3,8,8,3,3,3,8,3},
								{3,8,8,3,8,8,8,8,3,8,8,3},
								{3,8,8,3,8,8,8,8,3,8,8,3},
								{3,8,8,8,8,8,8,8,8,8,8,3},
								{3,8,8,8,3,3,3,3,8,8,8,3},
								{3,8,8,3,8,8,8,8,3,8,8,3},
								{8,3,8,8,8,8,8,8,8,8,3,8},
								{8,8,3,3,3,3,3,3,3,3,8,8}},


								{{8,8,8,8,8,8,8,8,8,8,8,8},	//Stage12
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,0,0,0,8,8,0,0,0,8,8},
								{8,0,8,8,8,0,0,8,8,8,0,8},
								{0,8,8,2,2,8,8,2,2,8,8,0},
								{0,8,2,8,8,2,2,8,8,2,8,0},
								{0,8,2,8,8,8,8,8,8,2,8,0},
								{0,8,2,8,8,8,8,8,8,2,8,0},
								{8,0,8,2,8,8,8,8,2,8,0,8},
								{8,8,0,8,2,8,8,2,8,0,8,8},
								{8,8,8,0,8,2,2,8,0,8,8,8},
								{8,8,8,8,0,8,8,0,8,8,8,8},
								{8,8,8,8,8,0,0,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8},
								{8,8,8,8,8,8,8,8,8,8,8,8}},
};

const int Rows = 21;
const int Cols = 14;
int Back[Rows][Cols];
int TempBack[Rows][Cols];
int cx, cy;
int Speed;
int Block;
int Color;
int NextBlock, NextBlock2;
int Chk, Cnt;
int Status;
int Temp;
int Temp_cx, Temp_cy;
int i, j, k;
char ScoreStr[50];
char StageStr[50];
char LineStr[50];
int Score, Stage, Line;
int LineLimit[11] = {5, 5, 7, 10, 12, 15, 20, 20, 25, 25, 30};
int StageSpeed[12] = {800, 750, 700, 650, 600, 550, 500, 450, 400, 350, 300, 250};
BOOL IsStart, IsEnd;
BOOL DownCheck;

LPSTR lpszClass="TETRIS By ZEONGUNY";
